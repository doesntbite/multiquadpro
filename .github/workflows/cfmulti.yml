name: Deploy 10 Workers with Custom Domains

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Workers with custom domains
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          for i in $(seq 1 2); do
            NAME="siren$i"
            DOMAIN="zxc$i.sumbangsih.dpdns.org"
            echo "ðŸš€ Deploying $NAME to https://$DOMAIN"

            # Buat file wrangler untuk masing-masing Worker
            cp wrangler.toml wrangler.temp.toml
            sed -i "s/^name = \".*\"/name = \"$NAME\"/" wrangler.temp.toml

            # Tambahkan deployment block
            echo "" >> wrangler.temp.toml
            echo "[deployments]" >> wrangler.temp.toml
            echo "custom_domain = true" >> wrangler.temp.toml

            # Deploy (akan otomatis setup domain + SSL)
            wrangler deploy --name $NAME --custom-domain https://$DOMAIN --config wrangler.temp.toml
          done
