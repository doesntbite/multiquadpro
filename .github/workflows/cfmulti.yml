name: Deploy 10 Workers with Custom Domains

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🧱 Setup Node.js (v20+ untuk Wrangler)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install Wrangler
        run: npm install -g wrangler

      - name: 🚀 Deploy Workers with Custom Domains
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cp wrangler.toml wrangler.toml.bak

          for i in {1..30}; do
            name="quadpro$i"
            domain="quadpro$i.eth0.dpdns.org"

            echo "🌐 Deploying $name → $domain"

            cp wrangler.toml.bak wrangler.temp.toml

            # Ganti name dan domain route
            sed -i "s/^name = \".*\"/name = \"$name\"/" wrangler.temp.toml
            sed -i "s|pattern = \".*\"|pattern = \"$domain\"|" wrangler.temp.toml

            # Deploy
            wrangler deploy --config wrangler.temp.toml

            echo "✅ Selesai deploy $name → $domain"
          done

          rm -f wrangler.temp.toml
