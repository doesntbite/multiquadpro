name: Deploy 10 Workers with Custom Domains

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Workers with Custom Domains
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          for i in $(seq 1 10); do
            WORKER="siren$i"
            DOMAIN="zxc$i.sumbangsih.dpdns.org"
            echo "ðŸš€ Deploying $WORKER to https://$DOMAIN"

            # Buat salinan wrangler.toml dasar
            cp wrangler.toml wrangler.temp.toml

            # Ganti name
            sed -i "s/^name = \".*\"/name = \"$WORKER\"/" wrangler.temp.toml

            # Tambahkan routes block
            echo "" >> wrangler.temp.toml
            echo "routes = [" >> wrangler.temp.toml
            echo "  { pattern = \"$DOMAIN\", custom_domain = true }" >> wrangler.temp.toml
            echo "]" >> wrangler.temp.toml

            # Deploy dengan custom domain
            wrangler deploy --config wrangler.temp.toml

            echo "âœ… Deployed $WORKER to https://$DOMAIN"
          done
